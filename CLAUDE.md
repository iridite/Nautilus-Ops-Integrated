# Claude AI Agent å¼€å‘æŒ‡å—

æœ¬æ–‡æ¡£ä¸º AI Agent æä¾›é¡¹ç›®å¼€å‘æŒ‡å—å’Œå·¥ä½œè§„èŒƒã€‚

## é¡¹ç›®æ¦‚è¿°

Nautilus Practice æ˜¯ä¸€ä¸ªåŠ å¯†è´§å¸é‡åŒ–äº¤æ˜“å›æµ‹å¹³å°ï¼ŒåŸºäº NautilusTrader æ¡†æ¶ã€‚

## æ ¸å¿ƒæ¶æ„

### 1. æ¨¡å—åŒ–ç­–ç•¥æ¶æ„

ç­–ç•¥ä»£ç ç»„ç»‡ä¸ºå¯å¤ç”¨ç»„ä»¶ï¼š
- `strategy/common/indicators/` - æŠ€æœ¯æŒ‡æ ‡ï¼ˆKeltnerã€RSI ç­‰ï¼‰
- `strategy/common/signals/` - ä¿¡å·ç”Ÿæˆå™¨ï¼ˆå…¥åœºã€å‡ºåœºï¼‰
- `strategy/common/universe/` - æ ‡çš„é€‰æ‹©ï¼ˆåŠ¨æ€ Universeï¼‰

### 2. åŒå›æµ‹å¼•æ“

- **ä½çº§å¼•æ“** (`backtest/engine_low.py`): ç®€å•ã€ç›´æ¥ã€æ˜“è°ƒè¯•
  - é€‚ç”¨åœºæ™¯ï¼šå¿«é€ŸéªŒè¯ã€è°ƒè¯•ç­–ç•¥é€»è¾‘ã€**è‡ªå®šä¹‰æ•°æ®ç±»å‹**
  - ä¼˜åŠ¿ï¼šç›´æ¥ API è°ƒç”¨ `engine.add_data()`ï¼Œæ— éœ€ Parquet catalog
  - é™åˆ¶ï¼šå¯èƒ½ä¸ç”Ÿæˆå®Œæ•´çš„ç»Ÿè®¡æ•°æ®ï¼ˆPNLã€Sharpe ç­‰ï¼‰

- **é«˜çº§å¼•æ“** (`backtest/engine_high.py`): å¿« 32%ã€Parquet ç¼“å­˜ã€10x æ•°æ®åŠ è½½é€Ÿåº¦
  - é€‚ç”¨åœºæ™¯ï¼šæ­£å¼å›æµ‹ã€æ€§èƒ½åˆ†æã€å‚æ•°ä¼˜åŒ–
  - ä¼˜åŠ¿ï¼šå®Œæ•´çš„ç»Ÿè®¡æ•°æ®ã€æ›´å¿«çš„æ‰§è¡Œé€Ÿåº¦
  - **è‡ªå®šä¹‰æ•°æ®æ”¯æŒ**: NautilusTrader å®Œå…¨æ”¯æŒï¼Œä½†éœ€è¦å…ˆå†™å…¥ Parquet catalog

**é‡è¦å‘ç° (2026-03-01)**:
- âœ… NautilusTrader çš„ BacktestNode **å®Œå…¨æ”¯æŒ**è‡ªå®šä¹‰æ•°æ®ç±»å‹ (FundingRateUpdate, è‡ªå®šä¹‰ Data å­ç±»)
- âœ… `BacktestDataConfig.data_cls` æ¥å—ä»»æ„ Data å­ç±»çš„å¯¼å…¥è·¯å¾„å­—ç¬¦ä¸²
- âŒ æˆ‘ä»¬çš„ `engine_high.py` ç¡¬ç¼–ç äº† `data_cls="Bar"`ï¼Œè¿™æ˜¯**å®ç°é™åˆ¶**ï¼Œä¸æ˜¯æ¶æ„é™åˆ¶
- ğŸ“ è¦åœ¨é«˜çº§å¼•æ“ä½¿ç”¨è‡ªå®šä¹‰æ•°æ®ï¼Œéœ€è¦å…ˆå†™å…¥ Parquet catalog

**å¼•æ“é€‰æ‹©æŒ‡å—**:
- çº¯ OHLCV æ•°æ®ç­–ç•¥ â†’ ä¼˜å…ˆä½¿ç”¨é«˜çº§å¼•æ“
- éœ€è¦è‡ªå®šä¹‰æ•°æ® (Funding Rate, OI) â†’ å½“å‰ä½¿ç”¨ä½çº§å¼•æ“
- æœªæ¥ä¼˜åŒ–æ–¹å‘ â†’ å®ç° Parquet catalog å†™å…¥ï¼Œç»Ÿä¸€ä½¿ç”¨é«˜çº§å¼•æ“

### 3. é…ç½®ç³»ç»Ÿ

3 å±‚æ¶æ„ï¼šYAML â†’ Pydantic éªŒè¯ â†’ Adapter â†’ åº”ç”¨

```python
from core.config_adapter import get_adapter

adapter = get_adapter()
strategy_config = adapter.get_strategy_config()
env_config = adapter.get_environment_config()
```

## å·¥ä½œè§„èŒƒ

### Git å·¥ä½œæµï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰

1. **å¼€å§‹ä»»ä½•å·¥ä½œå‰**ï¼Œå…ˆæ£€æŸ¥å½“å‰åˆ†æ”¯ï¼š
   ```bash
   git branch --show-current
   ```

2. **å¦‚æœåœ¨ main åˆ†æ”¯**ï¼Œç«‹å³åˆ›å»ºæ–°åˆ†æ”¯ï¼š
   ```bash
   git checkout -b <type>/<description>
   ```

3. **ç»ä¸ç›´æ¥åœ¨ main åˆ†æ”¯æäº¤**ï¼Œå³ä½¿æ˜¯å°æ”¹åŠ¨

4. **åˆ†æ”¯å‘½åè§„èŒƒ**:
   - `feat/`: æ–°åŠŸèƒ½ï¼ˆå¦‚ `feat/strategy-optimization`ï¼‰
   - `fix/`: Bug ä¿®å¤
   - `refactor/`: ä»£ç é‡æ„
   - `docs/`: æ–‡æ¡£æ›´æ–°
   - `test/`: æµ‹è¯•ç›¸å…³
   - `chore/`: æ„å»ºã€å·¥å…·ã€ä¾èµ–æ›´æ–°ï¼ˆå¦‚ `chore/fix-github-actions`ï¼‰

5. **åˆ†æ”¯å…³æ³¨ç‚¹åˆ†ç¦»**:
   - ç­–ç•¥ä¼˜åŒ– â†’ `feat/strategy-optimization`
   - åŸºç¡€è®¾æ–½æ”¹è¿› â†’ `chore/fix-github-actions`
   - ä¸è¦åœ¨åŠŸèƒ½åˆ†æ”¯ä¸­æ··å…¥åŸºç¡€è®¾æ–½ä¿®æ”¹

### Commit Message è§„èŒƒ

éµå¾ª Conventional Commits:

```
<type>(<scope>): <subject>

<body>

<footer>
```

**ç¤ºä¾‹**:
```
feat(strategy): add filter statistics and zero-trade diagnostics

- Add filter_stats tracking for 8 filters
- Implement _log_filter_statistics() with auto-warning
- Use ERROR level for 100% blocked warnings

Resolves: #123
```

### æµ‹è¯•è¦æ±‚

æäº¤å‰å¿…é¡»è¿è¡Œæµ‹è¯•ï¼š

```bash
uv run python -m unittest discover -s tests -p "test_*.py" -v
```

## å¼€å‘æŒ‡å—

### æ·»åŠ æ–°ç­–ç•¥

1. åˆ›å»ºç­–ç•¥æ–‡ä»¶ï¼š`strategy/my_strategy.py`
2. ç»§æ‰¿ `Strategy` åŸºç±»
3. å®ç°æ ¸å¿ƒæ–¹æ³•ï¼š`on_bar()`, `on_stop()`
4. æ·»åŠ é…ç½®ï¼š`config/strategies/my_strategy.yaml`
5. ç¼–å†™æµ‹è¯•ï¼š`tests/test_my_strategy.py`

### æ·»åŠ æ–°ç»„ä»¶

1. é€‰æ‹©ç»„ä»¶ç±»å‹ï¼šindicators / signals / universe
2. åˆ›å»ºæ–‡ä»¶ï¼š`strategy/common/<type>/my_component.py`
3. å®ç°æ¥å£
4. ç¼–å†™å•å…ƒæµ‹è¯•
5. æ›´æ–°æ–‡æ¡£

### è°ƒè¯•é›¶äº¤æ˜“é—®é¢˜

ä½¿ç”¨è¿‡æ»¤å™¨è¯Šæ–­ç³»ç»Ÿï¼š

1. å¯ç”¨ DEBUG æ—¥å¿—ï¼š
   ```yaml
   # config/environments/dev.yaml
   logging:
     level: "DEBUG"
     components_only: false
   ```

2. è¿è¡Œå›æµ‹æŸ¥çœ‹è¿‡æ»¤å™¨ç»Ÿè®¡

3. æ ¹æ®ç»Ÿè®¡æŠ¥å‘Šè°ƒæ•´é…ç½®

## å…³é”®ç»éªŒæ•™è®­

### 1. Git åˆ†æ”¯ç®¡ç†

**é—®é¢˜**: AI Agent ä¸¤æ¬¡ç›´æ¥åœ¨ main åˆ†æ”¯æäº¤ä»£ç 

**æ ¹æœ¬åŸå› **: pre-push hook åªèƒ½é˜»æ­¢æ¨é€ï¼Œæ— æ³•é˜»æ­¢æœ¬åœ°æäº¤

**è§£å†³æ–¹æ¡ˆ**: å¼€å§‹å·¥ä½œå‰ä¸»åŠ¨æ£€æŸ¥åˆ†æ”¯ï¼Œä¸ä¾èµ– hook æé†’

### 2. CI/CD ä»£ç æ ¼å¼æ£€æŸ¥

**é—®é¢˜**: PR æäº¤å CI å¤±è´¥ï¼ŒåŸå› æ˜¯ä»£ç æ ¼å¼ä¸ç¬¦åˆ ruff è§„èŒƒ

**ç°è±¡**:
- `ruff check` é€šè¿‡ï¼Œä½† `ruff format --check` å¤±è´¥
- é”™è¯¯ä¿¡æ¯ï¼š`Would reformat: <file>`
- å¯¼è‡´ Lint Check å’Œ Auto Merge å¤±è´¥

**æ ¹æœ¬åŸå› **:
- æœ¬åœ°æäº¤å‰æ²¡æœ‰è¿è¡Œ `ruff format`
- åªè¿è¡Œäº† `ruff check`ï¼ˆæ£€æŸ¥è¯­æ³•é”™è¯¯ï¼‰
- æ ¼å¼æ£€æŸ¥ï¼ˆformatï¼‰å’Œè¯­æ³•æ£€æŸ¥ï¼ˆcheckï¼‰æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„æ­¥éª¤

**è§£å†³æ–¹æ¡ˆ**:
1. **æäº¤å‰å¿…é¡»è¿è¡Œä¸¤ä¸ªå‘½ä»¤**:
   ```bash
   uv run ruff check .      # æ£€æŸ¥è¯­æ³•é”™è¯¯
   uv run ruff format .     # è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç 
   ```

2. **æ¨èå·¥ä½œæµ**:
   ```bash
   # ä¿®æ”¹ä»£ç å
   uv run ruff format .     # å…ˆæ ¼å¼åŒ–
   uv run ruff check .      # å†æ£€æŸ¥è¯­æ³•
   git add .
   git commit -m "..."
   git push
   ```

3. **CI å¤±è´¥åçš„ä¿®å¤æµç¨‹**:
   ```bash
   # æŸ¥çœ‹å“ªäº›æ–‡ä»¶éœ€è¦æ ¼å¼åŒ–
   uv run ruff format --check .

   # è‡ªåŠ¨æ ¼å¼åŒ–
   uv run ruff format <files>

   # æäº¤ä¿®å¤
   git add <files>
   git commit -m "style: fix ruff format issues"
   git push
   ```

**æ•™è®­**:
- ä»£ç æ ¼å¼åŒ–æ˜¯ CI çš„å¼ºåˆ¶è¦æ±‚ï¼Œä¸æ˜¯å¯é€‰é¡¹
- æœ¬åœ°å¼€å‘æ—¶å…»æˆå…ˆæ ¼å¼åŒ–å†æäº¤çš„ä¹ æƒ¯
- å¯ä»¥è€ƒè™‘æ·»åŠ  pre-commit hook è‡ªåŠ¨è¿è¡Œ ruff format

### 2. è¿‡æ»¤å™¨ç»„åˆæ•ˆåº”

**é—®é¢˜**: å¤šä¸ªç‹¬ç«‹è¿‡æ»¤å™¨å¯¼è‡´ 100% ä¿¡å·è¢«æ‹¦æˆª

**åŸå› **: ç»„åˆæ¦‚ç‡æ˜¯ä¹˜æ³•å…³ç³»ï¼ˆ8 ä¸ªè¿‡æ»¤å™¨ Ã— 90% é€šè¿‡ç‡ = 43% æ€»é€šè¿‡ç‡ï¼‰

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨è¿‡æ»¤å™¨ç»Ÿè®¡ç³»ç»Ÿé‡åŒ–æ¯ä¸ªè¿‡æ»¤å™¨çš„å½±å“

### 3. NautilusTrader å¤šæ ‡çš„æœºåˆ¶

**å…³é”®å‘ç°**: æ¯ä¸ªç­–ç•¥å®ä¾‹åªèƒ½äº¤æ˜“ä¸€ä¸ªæ ‡çš„

**å½±å“**: `universe_top_n: 15` ä¼šåˆ›å»º 15 ä¸ªç‹¬ç«‹ç­–ç•¥å®ä¾‹

**è®¾è®¡å»ºè®®**:
- Universe å¤§å°è¦åˆç†ï¼ˆå¤ªå° â†’ ä¿¡å·è¢«æ‹¦æˆªï¼Œå¤ªå¤§ â†’ èµ„é‡‘åˆ†æ•£ï¼‰
- æ›´æ–°é¢‘ç‡è¦åŒ¹é…ç­–ç•¥å‘¨æœŸ

### 4. æ•°æ®å‘¨æœŸåŒ¹é…

**é—®é¢˜**: ä½¿ç”¨ 1h æ•°æ®è¿è¡Œæ—¥çº¿ç­–ç•¥ä¼šå°†æŒ‡æ ‡æ—¶é—´å°ºåº¦å‹ç¼© 24 å€

**è§£å†³æ–¹æ¡ˆ**: ä¸¥æ ¼åŒ¹é…æ•°æ®å‘¨æœŸå’Œç­–ç•¥é…ç½®

### 5. æ—¥å¿—é…ç½®çš„å½±å“

**é—®é¢˜**: `components_only: true` ä¼šè¿‡æ»¤ç­–ç•¥å®ä¾‹æ—¥å¿—

**è§£å†³æ–¹æ¡ˆ**: è°ƒè¯•æ—¶è®¾ç½® `components_only: false`

### 6. å›æµ‹å¼•æ“é€‰æ‹©

**é—®é¢˜**: ä½çº§å¼•æ“å¯èƒ½ä¸ç”Ÿæˆå®Œæ•´çš„ç»Ÿè®¡æ•°æ®

**ç°è±¡**:
- `pnl` å’Œ `returns` å­—æ®µä¸ºç©º
- åªæœ‰åŸºæœ¬çš„è®¢å•å’ŒæŒä»“ç»Ÿè®¡

**è§£å†³æ–¹æ¡ˆ**:
- æ­£å¼å›æµ‹ä½¿ç”¨é«˜çº§å¼•æ“ï¼š`--type high`
- ä½çº§å¼•æ“ä»…ç”¨äºå¿«é€Ÿè°ƒè¯•

### 7. å‚æ•°è°ƒä¼˜çš„å…³é”®å½±å“

**é—®é¢˜**: è¿‡äºä¿ï¿½ï¿½çš„å‚æ•°å¯¼è‡´æ‰€æœ‰ä¿¡å·è¢«è¿‡æ»¤

**å…³é”®å‚æ•°**:
- `keltner_trigger_multiplier`: 1.5 å¤ªä¸¥æ ¼ â†’ å»ºè®® 2.0-2.3
- `deviation_threshold`: 0.25 å¤ªä¸¥æ ¼ â†’ å»ºè®® 0.30-0.35
- `stop_loss_atr_multiplier`: å½±å“é£é™©æ§åˆ¶ï¼Œå»ºè®® 2.4-2.8

**æ•™è®­**:
- å‚æ•°å¾®è°ƒå¯¹äº¤æ˜“æ•°é‡å½±å“å·¨å¤§
- ä½¿ç”¨ `feat/strategy-optimization` åˆ†æ”¯è¿›è¡Œå‚æ•°å®éªŒ
- å¯¹æ¯”ä¸åŒå‚æ•°ç»„åˆçš„å›æµ‹ç»“æœ

## æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åŠ è½½

- ä½¿ç”¨ Parquet ç¼“å­˜ï¼š10x é€Ÿåº¦æå‡
- é¿å…é‡å¤ CSV è¯»å–
- æ‰¹é‡å¤„ç†æ•°æ®

### å›æµ‹å¼•æ“

- é«˜çº§å¼•æ“æ¯”ä½çº§å¼•æ“å¿« 32%
- ä½¿ç”¨ cProfile è¯†åˆ«ç“¶é¢ˆ
- ä¼˜åŒ–æ•°æ®åŠ è½½æ˜¯å…³é”®

## å¸¸ç”¨å‘½ä»¤

```bash
# æ£€æŸ¥å½“å‰åˆ†æ”¯
git branch --show-current

# åˆ›å»ºæ–°åˆ†æ”¯
git checkout -b <type>/<description>

# ä»£ç æ£€æŸ¥å’Œæ ¼å¼åŒ–ï¼ˆæäº¤å‰å¿…é¡»è¿è¡Œï¼‰
uv run ruff format .     # è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç 
uv run ruff check .      # æ£€æŸ¥è¯­æ³•é”™è¯¯

# è¿è¡Œæµ‹è¯•
uv run python -m unittest discover -s tests -p "test_*.py" -v

# è¿è¡Œå›æµ‹ï¼ˆæ¨èé«˜çº§å¼•æ“ï¼‰
uv run python main.py backtest --type high

# åˆ†æå›æµ‹ç»“æœ
python scripts/analyze_backtest_results.py

# æŸ¥çœ‹å˜æ›´
git status
git diff

# æŸ¥çœ‹æœ€æ–°å›æµ‹ç»“æœ
ls -lht output/backtest/result/*.json | head -3
```

## è¯¦ç»†æ–‡æ¡£

æ›´å¤šè¯¦ç»†ä¿¡æ¯è¯·å‚è€ƒï¼š

- [æ¶æ„å†³ç­–è®°å½•](docs/lessons-learned/ARCHITECTURE_DECISIONS.md)
- [TUI é›†æˆç»éªŒ](docs/lessons-learned/TUI_INTEGRATION.md)
- [Git å·¥ä½œæµ](docs/lessons-learned/GIT_WORKFLOW.md)
- [ç­–ç•¥è°ƒè¯•ä¸è¯Šæ–­](docs/lessons-learned/STRATEGY_DEBUGGING.md)

## æ³¨æ„äº‹é¡¹

1. **ä¿ç•™ debug æ—¥å¿—**: ç”¨æˆ·æ˜ç¡®è¦æ±‚ä¿ç•™æ‰€æœ‰ debug æ—¥å¿—ä¿¡æ¯
2. **åŒå¼•æ“è®¾è®¡**: ç»´æŒä½çº§å’Œé«˜çº§å¼•æ“ï¼Œä¸éœ€è¦ä¼˜åŒ–è°ƒç”¨ä»£ç 
3. **æµ‹è¯•ä¼˜å…ˆ**: æäº¤å‰å¿…é¡»è¿è¡Œæµ‹è¯•
4. **å°æ­¥æäº¤**: æ¯ä¸ª commit åªåšä¸€ä»¶äº‹
5. **æè¿°æ€§æ¶ˆæ¯**: æ¸…æ™°è¯´æ˜"ä¸ºä»€ä¹ˆ"è€Œé"æ˜¯ä»€ä¹ˆ"
