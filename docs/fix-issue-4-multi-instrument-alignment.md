# é—®é¢˜4ä¿®å¤ï¼šå¤šæ ‡çš„æ•°æ®å¯¹é½æ£€æŸ¥

## é—®é¢˜æè¿°

### å‘ç°çš„é—®é¢˜
åœ¨å›æµ‹æµç¨‹è¿½è¸ªä¸­å‘ç°ï¼Œè™½ç„¶ç³»ç»Ÿå·²ç»å®ç°äº†å®Œæ•´çš„å¤šæ ‡çš„æ•°æ®å¯¹é½æ£€æŸ¥åŠŸèƒ½ï¼Œä½†è¿™ä¸ªåŠŸèƒ½ä»æœªè¢«è°ƒç”¨ã€‚

**å½±å“èŒƒå›´**ï¼š
- ç­–ç•¥ä¾èµ–å¤šä¸ªæ ‡çš„ï¼ˆå¦‚ä¸»æ ‡çš„ + BTCï¼‰æ—¶ï¼Œæ•°æ®å¯èƒ½ä¸å¯¹é½
- å¯èƒ½å¯¼è‡´æœªæ¥å‡½æ•°é—®é¢˜ï¼ˆä½¿ç”¨äº†å°šæœªå‘ç”Ÿçš„æ•°æ®ï¼‰
- å›æµ‹ç»“æœå¯èƒ½ä¸å‡†ç¡®

**ä¸¥é‡ç¨‹åº¦**ï¼šâš ï¸ ä¸­ç­‰

### å…·ä½“åœºæ™¯

ä»¥ Keltner RS Breakout ç­–ç•¥ä¸ºä¾‹ï¼š
- ä¸»æ ‡çš„ï¼šETHUSDT-PERP
- è¾…åŠ©æ ‡çš„ï¼šBTCUSDT-PERPï¼ˆç”¨äºå¸‚åœºçŠ¶æ€åˆ¤æ–­ï¼‰

å¦‚æœä¸¤ä¸ªæ ‡çš„çš„æ•°æ®æ—¶é—´æˆ³ä¸å¯¹é½ï¼š
```
ETHUSDT: [2025-01-01, 2025-01-02, 2025-01-03, ...]
BTCUSDT: [2025-01-01, 2025-01-03, 2025-01-04, ...]  # ç¼ºå°‘ 2025-01-02
```

å¯èƒ½å¯¼è‡´ï¼š
1. åœ¨ 2025-01-02 ä½¿ç”¨äº† 2025-01-03 çš„ BTC æ•°æ®ï¼ˆæœªæ¥å‡½æ•°ï¼‰
2. ç­–ç•¥ä¿¡å·ä¸å‡†ç¡®
3. å›æµ‹ç»“æœå¤±çœŸ

## å·²æœ‰çš„å®ç°

ç³»ç»Ÿå·²ç»å®ç°äº†ä¸¤ä¸ªå…³é”®å‡½æ•°ï¼š

### 1. `validate_multi_instrument_alignment()`
ä½ç½®ï¼š`utils/data_management/data_validator.py`

åŠŸèƒ½ï¼š
- éªŒè¯ä¸¤ä¸ª CSV æ–‡ä»¶çš„æ—¶é—´æˆ³å¯¹é½æƒ…å†µ
- è®¡ç®—å¯¹é½ç‡ï¼ˆå…±åŒæ—¶é—´æˆ³ / æ€»æ—¶é—´æˆ³ï¼‰
- æ”¯æŒè‡ªå®šä¹‰å¯¹é½ç‡é˜ˆå€¼ï¼ˆé»˜è®¤ 95%ï¼‰

### 2. `_check_multi_instrument_alignment()`
ä½ç½®ï¼š`utils/data_management/data_validator.py`

åŠŸèƒ½ï¼š
- ä»ç­–ç•¥é…ç½®ä¸­æå–è¾…åŠ©æ ‡çš„ä¿¡æ¯ï¼ˆå¦‚ `btc_instrument_id`ï¼‰
- æ„å»º CSV æ–‡ä»¶è·¯å¾„
- è°ƒç”¨ `validate_multi_instrument_alignment()` è¿›è¡Œæ£€æŸ¥
- è®°å½•æ£€æŸ¥ç»“æœ

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹å†…å®¹

åœ¨ `prepare_data_feeds()` å‡½æ•°ä¸­æ·»åŠ å¤šæ ‡çš„å¯¹é½æ£€æŸ¥ï¼š

```python
def prepare_data_feeds(args, adapter, base_dir, universe_symbols: set):
    """å‡†å¤‡æ•°æ®æµï¼ˆéªŒè¯æˆ–è·å–ï¼‰"""
    # ... ç°æœ‰çš„æ•°æ®æ£€æŸ¥å’Œè·å–é€»è¾‘ ...
    
    # æ£€æŸ¥å¤šæ ‡çš„æ•°æ®å¯¹é½ï¼ˆå¦‚æœç­–ç•¥éœ€è¦ï¼‰
    _check_multi_instrument_alignment(adapter, base_dir, venue, timeframe)
    logger.info("")  # ç©ºè¡Œåˆ†éš”
```

### ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªä½ç½®ï¼Ÿ

1. **æ—¶æœºåˆé€‚**ï¼šåœ¨æ•°æ®è·å–ä¹‹åã€å›æµ‹è¿è¡Œä¹‹å‰
2. **é€»è¾‘è‡ªç„¶**ï¼š`prepare_data_feeds()` è´Ÿè´£æ•°æ®éªŒè¯ï¼Œå¯¹é½æ£€æŸ¥æ˜¯éªŒè¯çš„ä¸€éƒ¨åˆ†
3. **æ—©æœŸå‘ç°**ï¼šå¯ä»¥åœ¨å›æµ‹å¼€å§‹å‰å°±å‘ç°æ•°æ®é—®é¢˜
4. **ä¸å½±å“æ€§èƒ½**ï¼šåªåœ¨éœ€è¦æ—¶ï¼ˆç­–ç•¥æœ‰ `btc_instrument_id`ï¼‰æ‰æ‰§è¡Œæ£€æŸ¥

### æ‰§è¡Œæµç¨‹

```
main.py
  â†“
prepare_data_feeds()
  â”œâ”€ æ£€æŸ¥ OHLCV æ•°æ®æ˜¯å¦å­˜åœ¨
  â”œâ”€ è·å–ç¼ºå¤±çš„æ•°æ®
  â””â”€ æ£€æŸ¥å¤šæ ‡çš„æ•°æ®å¯¹é½ â† æ–°å¢
      â”œâ”€ æ£€æŸ¥ç­–ç•¥æ˜¯å¦éœ€è¦è¾…åŠ©æ ‡çš„
      â”œâ”€ æå–ä¸»æ ‡çš„å’Œè¾…åŠ©æ ‡çš„çš„ symbol
      â”œâ”€ æ„å»º CSV æ–‡ä»¶è·¯å¾„
      â”œâ”€ è°ƒç”¨ validate_multi_instrument_alignment()
      â””â”€ è®°å½•æ£€æŸ¥ç»“æœ
  â†“
check_and_fetch_strategy_data()
  â†“
run_backtest()
```

## æµ‹è¯•éªŒè¯

æ·»åŠ äº†ä¸‰ä¸ªæµ‹è¯•ç”¨ä¾‹æ¥éªŒè¯ä¿®å¤ï¼š

### 1. `test_prepare_data_feeds_calls_alignment_check`
éªŒè¯ `prepare_data_feeds()` æ­£ç¡®è°ƒç”¨å¯¹é½æ£€æŸ¥

### 2. `test_prepare_data_feeds_skip_data_check`
éªŒè¯è·³è¿‡æ•°æ®æ£€æŸ¥æ—¶ä¸è°ƒç”¨å¯¹é½æ£€æŸ¥

### 3. `test_prepare_data_feeds_with_missing_data`
éªŒè¯å³ä½¿æœ‰ç¼ºå¤±æ•°æ®ï¼Œå¯¹é½æ£€æŸ¥ä»ç„¶æ‰§è¡Œ

æ‰€æœ‰æµ‹è¯•å‡é€šè¿‡ âœ…

### æµ‹è¯•è¿è¡Œç»“æœ

```bash
$ uv run python -m pytest tests/test_data_validator.py::TestPrepareDataFeeds -v --no-cov

collected 3 items

tests/test_data_validator.py::TestPrepareDataFeeds::test_prepare_data_feeds_calls_alignment_check PASSED
tests/test_data_validator.py::TestPrepareDataFeeds::test_prepare_data_feeds_skip_data_check PASSED
tests/test_data_validator.py::TestPrepareDataFeeds::test_prepare_data_feeds_with_missing_data PASSED

============================= 3 passed in 0.67s =============================
```

### é›†æˆéªŒè¯

åˆ›å»ºäº†éªŒè¯è„šæœ¬ `scripts/verify_alignment_check.py` è¿›è¡Œç«¯åˆ°ç«¯æµ‹è¯•ï¼š

```bash
$ uv run python scripts/verify_alignment_check.py

ğŸ” å¼€å§‹éªŒè¯å¤šæ ‡çš„æ•°æ®å¯¹é½æ£€æŸ¥åŠŸèƒ½
============================================================
æµ‹è¯•1: éªŒè¯å¯¹é½æ£€æŸ¥è¢«è°ƒç”¨
âœ… å¯¹é½æ£€æŸ¥è¢«æ­£ç¡®è°ƒç”¨

æµ‹è¯•2: éªŒè¯è·³è¿‡æ•°æ®æ£€æŸ¥æ—¶ä¸è°ƒç”¨å¯¹é½æ£€æŸ¥
âœ… è·³è¿‡æ•°æ®æ£€æŸ¥æ—¶æ­£ç¡®åœ°ä¸è°ƒç”¨å¯¹é½æ£€æŸ¥

æµ‹è¯•3: éªŒè¯æœ‰ btc_instrument_id æ—¶æ‰§è¡Œå¯¹é½æ£€æŸ¥
âœ… ç­–ç•¥é…ç½®åŒ…å« btc_symbol: BTCUSDT
âœ… ç­–ç•¥å‚æ•°åŒ…å« btc_instrument_id: BTC-USDT-PERP.BINANCE
   è¿™æ„å‘³ç€å¯¹é½æ£€æŸ¥ä¼šè¢«æ‰§è¡Œ

ğŸ“Š æµ‹è¯•ç»“æœæ€»ç»“
============================================================
âœ… é€šè¿‡ - å¯¹é½æ£€æŸ¥è¢«è°ƒç”¨
âœ… é€šè¿‡ - è·³è¿‡æ•°æ®æ£€æŸ¥
âœ… é€šè¿‡ - BTC æ ‡çš„æ£€æµ‹
============================================================
æ€»è®¡: 3/3 æµ‹è¯•é€šè¿‡
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼é—®é¢˜4ä¿®å¤éªŒè¯æˆåŠŸï¼
```

## ä½¿ç”¨ç¤ºä¾‹

### æ­£å¸¸æƒ…å†µï¼ˆæ•°æ®å¯¹é½ï¼‰

```bash
$ uv run python main.py backtest

ğŸ“Š Data Validation
âœ… All data files present
ğŸ” æ£€æŸ¥å¤šæ ‡çš„æ•°æ®å¯¹é½: ETHUSDT-PERP vs BTCUSDT-PERP
âœ… æ•°æ®å¯¹é½éªŒè¯é€šè¿‡
```

### å¼‚å¸¸æƒ…å†µï¼ˆæ•°æ®ä¸å¯¹é½ï¼‰

```bash
$ uv run python main.py backtest

ğŸ“Š Data Validation
âœ… All data files present
ğŸ” æ£€æŸ¥å¤šæ ‡çš„æ•°æ®å¯¹é½: ETHUSDT-PERP vs BTCUSDT-PERP
âš ï¸  æ•°æ®å¯¹é½è­¦å‘Š: å¯¹é½ç‡è¿‡ä½ (85.3%)ï¼Œä½äºé˜ˆå€¼ 95.0%
   å»ºè®®: æ£€æŸ¥æ•°æ®æºæˆ–é‡æ–°ä¸‹è½½æ•°æ®
```

### ç­–ç•¥ä¸éœ€è¦è¾…åŠ©æ ‡çš„

```bash
$ uv run python main.py backtest

ğŸ“Š Data Validation
âœ… All data files present
# ä¸ä¼šæ‰§è¡Œå¯¹é½æ£€æŸ¥
```

## å¯¹é½æ£€æŸ¥é€»è¾‘

### æ£€æµ‹æ¡ä»¶

åªæœ‰å½“ç­–ç•¥é…ç½®ä¸­åŒ…å« `btc_instrument_id` æ—¶æ‰æ‰§è¡Œæ£€æŸ¥ï¼š

```python
btc_instrument_id = getattr(strategy_params, "btc_instrument_id", None)
if not btc_instrument_id:
    return  # ç­–ç•¥ä¸éœ€è¦å¤šæ ‡çš„å¯¹é½æ£€æŸ¥
```

### å¯¹é½ç‡è®¡ç®—

```python
common_timestamps = primary_timestamps & secondary_timestamps
alignment_rate = len(common_timestamps) / len(primary_timestamps)
```

### é˜ˆå€¼åˆ¤æ–­

é»˜è®¤è¦æ±‚ 95% çš„å¯¹é½ç‡ï¼š
- â‰¥ 95%ï¼šé€šè¿‡ âœ…
- < 95%ï¼šè­¦å‘Š âš ï¸

## é”™è¯¯å¤„ç†

å¯¹é½æ£€æŸ¥å¤±è´¥ä¸ä¼šä¸­æ–­å›æµ‹æµç¨‹ï¼Œåªä¼šè®°å½•è­¦å‘Šï¼š

```python
try:
    is_aligned, error_msg = validate_multi_instrument_alignment(...)
    if not is_aligned:
        logger.error(f"âš ï¸  æ•°æ®å¯¹é½è­¦å‘Š: {error_msg}")
        logger.info("   å»ºè®®: æ£€æŸ¥æ•°æ®æºæˆ–é‡æ–°ä¸‹è½½æ•°æ®")
    else:
        logger.info("âœ… æ•°æ®å¯¹é½éªŒè¯é€šè¿‡")
except Exception as e:
    logger.warning(f"å¤šæ ‡çš„å¯¹é½æ£€æŸ¥å¤±è´¥: {e}")
```

**è®¾è®¡ç†ç”±**ï¼š
- æ•°æ®å¯¹é½é—®é¢˜å¯èƒ½æ˜¯æš‚æ—¶çš„ï¼ˆå¦‚æ•°æ®æºå»¶è¿Ÿï¼‰
- ç”¨æˆ·å¯èƒ½æœ‰æ„ä½¿ç”¨ä¸å®Œå…¨å¯¹é½çš„æ•°æ®
- ç»™ç”¨æˆ·é€‰æ‹©æƒï¼Œè€Œä¸æ˜¯å¼ºåˆ¶ä¸­æ–­

## åç»­æ”¹è¿›å»ºè®®

### 1. å¯é…ç½®çš„å¯¹é½ç‡é˜ˆå€¼
å…è®¸ç”¨æˆ·åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®å¯¹é½ç‡é˜ˆå€¼ï¼š

```yaml
backtest:
  data_alignment:
    min_rate: 0.95
    strict_mode: false  # true æ—¶å¯¹é½å¤±è´¥ä¼šä¸­æ–­å›æµ‹
```

### 2. æ”¯æŒæ›´å¤šè¾…åŠ©æ ‡çš„
å½“å‰åªæ£€æŸ¥ `btc_instrument_id`ï¼Œæœªæ¥å¯ä»¥æ‰©å±•åˆ°ï¼š
- `pairs` é…ç½®ï¼ˆKalman Pairs ç­–ç•¥ï¼‰
- è‡ªå®šä¹‰è¾…åŠ©æ ‡çš„åˆ—è¡¨

### 3. è¯¦ç»†çš„å¯¹é½æŠ¥å‘Š
ç”Ÿæˆè¯¦ç»†çš„å¯¹é½æŠ¥å‘Šï¼ŒåŒ…æ‹¬ï¼š
- ç¼ºå¤±çš„æ—¶é—´æˆ³åˆ—è¡¨
- å¯¹é½ç‡è¶‹åŠ¿å›¾
- å»ºè®®çš„ä¿®å¤æ–¹æ¡ˆ

### 4. è‡ªåŠ¨ä¿®å¤
æä¾›è‡ªåŠ¨å¯¹é½åŠŸèƒ½ï¼š
- åˆ é™¤ä¸å¯¹é½çš„æ—¶é—´æˆ³
- æ’å€¼å¡«å……ç¼ºå¤±æ•°æ®
- ç”Ÿæˆå¯¹é½åçš„æ•°æ®æ–‡ä»¶

## ç›¸å…³æ–‡ä»¶

- `utils/data_management/data_validator.py` - å¯¹é½æ£€æŸ¥å®ç°
- `tests/test_data_validator.py` - æµ‹è¯•ç”¨ä¾‹
- `main.py` - å›æµ‹å…¥å£

## ä¿®å¤æ—¥æœŸ

2025-01-24

## ä¿®å¤çŠ¶æ€

âœ… å·²å®Œæˆå¹¶éªŒè¯
- ä»£ç ä¿®æ”¹ï¼šå®Œæˆ
- å•å…ƒæµ‹è¯•ï¼š3/3 é€šè¿‡
- é›†æˆéªŒè¯ï¼š3/3 é€šè¿‡
- æ–‡æ¡£æ›´æ–°ï¼šå®Œæˆ

## ä¿®å¤äººå‘˜

Kiro AI Assistant