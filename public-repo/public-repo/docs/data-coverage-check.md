# 数据覆盖率检查说明

## 概述

回测系统在加载数据时会检查 Parquet 数据对回测时间范围的覆盖率，并根据覆盖率情况输出不同级别的日志。

## 覆盖率计算

覆盖率 = (实际数据时间范围 / 回测要求时间范围) × 100%

**示例：**
- 回测时间范围：2022-01-01 到 2026-01-01（4年 = 1461天）
- AGLDUSDT 数据范围：2023-07-29 到 2025-12-31（2.4年 = 887天）
- 覆盖率：887 / 1461 ≈ 60.7%

## 日志级别阈值

| 覆盖率范围 | 日志级别 | 说明 |
|-----------|---------|------|
| < 30% | WARNING | 数据严重不足，可能影响回测结果的可靠性 |
| 30% - 95% | INFO | 数据部分覆盖，新币种常见情况 |
| ≥ 95% | DEBUG | 数据完整，符合预期 |

## 重要说明

### ⚠️ 覆盖率不足不会阻止交易

**覆盖率检查只是信息性警告，不影响实际回测执行：**

1. **数据加载**：无论覆盖率多少，所有可用数据都会被加载
2. **交易执行**：在有数据的时间段内，策略可以正常产生信号和执行交易
3. **实际影响**：只是在没有数据的时间段，该交易对不会参与回测

**示例：**
- AGLDUSDT 覆盖率 60.7%（2023-07-29 上市）
- 2022-01-01 到 2023-07-28：无数据，不参与回测
- 2023-07-29 到 2025-12-31：**有数据，可以正常交易** ✅
- 如果 2024 年有信号，完全可以正常买入

## 常见场景

### 场景 1：新币种上市晚

很多山寨币上市时间晚于回测起始时间，这是正常现象。

**示例：**
- 回测配置：2022-01-01 开始
- AGLDUSDT：2023-07-29 上市（覆盖率 60.7%）
- ACTUSDT：可能更晚上市（覆盖率 28.4%）

**处理方式：**
- 覆盖率 > 30%：INFO 级别，正常情况
- 覆盖率 < 30%：WARNING 级别，提醒数据过少

### 场景 2：数据下载不完整

如果覆盖率异常低（< 30%），可能是：
- 数据下载失败或中断
- 交易所 API 限流导致部分数据缺失
- 交易对已退市或暂停交易

**建议：**
- 检查数据文件是否完整
- 重新运行数据下载脚本（使用 `--force` 强制覆盖）
- 考虑从回测中排除该交易对

### 场景 3：回测时间范围过长

如果回测时间范围设置过长（如 2020-2026），会导致大量新币种覆盖率不足。

**建议：**
- 根据策略需求调整回测时间范围
- 对于新币种策略，可以从 2023 年开始回测
- 对于老币种策略，可以从 2020 年开始回测

## 配置说明

### 回测时间范围

在 `config/environments/dev.yaml` 中配置：

```yaml
backtest:
  start_date: "2022-01-01"
  end_date: "2026-01-01"
```

### 数据下载时间范围

在 `scripts/prepare_top_data.py` 中默认从 2020-01-01 开始：

```bash
# 默认下载（从 2020-01-01 开始）
python scripts/prepare_top_data.py

# 自定义时间范围
python scripts/prepare_top_data.py --start-date 2023-01-01
```

## 技术实现

### 代码位置

`backtest/engine_high.py` 中的 `_check_parquet_coverage()` 函数

### 关键逻辑

```python
COVERAGE_THRESHOLD = 95.0  # 完整数据阈值
WARNING_THRESHOLD = 30.0   # 警告阈值

if coverage_pct < WARNING_THRESHOLD:
    logger.warning(f"Coverage critically low: {coverage_pct:.1f}%")
elif coverage_pct < COVERAGE_THRESHOLD:
    logger.info(f"Coverage partial: {coverage_pct:.1f}%")
else:
    logger.debug(f"Coverage OK: {coverage_pct:.1f}%")
```

### 数据加载流程

1. 检查 Parquet 数据覆盖率
2. 输出相应级别的日志
3. **无论覆盖率多少，都会创建 BacktestDataConfig**
4. NautilusTrader 引擎加载所有可用数据
5. 在有数据的时间段内正常执行回测

## 最佳实践

1. **不要过度担心 30-95% 的覆盖率**：这是新币种的正常情况
2. **关注 < 30% 的警告**：可能需要检查数据完整性
3. **根据策略调整时间范围**：避免不必要的覆盖率警告
4. **定期更新数据**：确保数据覆盖到最新日期

## 相关文档

- [数据下载优化](./data-download-optimization.md)
- [回测系统问题分析](./backtest_issues_analysis.md)