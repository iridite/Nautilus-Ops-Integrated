name: Sync to Public Repo

on:
  push:
    branches: [main]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout public repo
        uses: actions/checkout@v4
        with:
          repository: iridite/Nautilus-Ops-Integrated
          token: ${{ secrets.PUBLIC_REPO_TOKEN }}
          path: public-repo
          fetch-depth: 0

      - name: Sync files to public repo
        run: |
          # 排除的文件模式
          EXCLUDE_PATTERNS=(
            ".git"
            ".env"
            "test.env"
            "data/"
            "output/"
            "log/"
            ".venv"
            "__pycache__"
            "*.pyc"
            ".idea"
            ".vscode"
            ".DS_Store"
            ".aider*"
            ".langgraph_api"
            ".ruff_cache"
            ".claude"
            "tmp/"
          )

          # 敏感文件
          SENSITIVE_FILES=(
            "strategy/keltner_rs_breakout.py"
            "config/strategies/keltner_rs_breakout.yaml"
            "tests/test_keltner_rs_breakout.py"
            "docs/reviews/dk_alpha_trend_audit.md"
          )

          # 构建 rsync 排除参数
          RSYNC_EXCLUDE=""
          for pattern in "${EXCLUDE_PATTERNS[@]}"; do
            RSYNC_EXCLUDE="$RSYNC_EXCLUDE --exclude=\"$pattern\""
          done

          for file in "${SENSITIVE_FILES[@]}"; do
            RSYNC_EXCLUDE="$RSYNC_EXCLUDE --exclude=\"$file\""
          done

          # 同步文件（忽略 code 24 - 文件在传输中消失，通常是临时文件）
          set +e
          eval rsync -av --delete $RSYNC_EXCLUDE ./ public-repo/
          RSYNC_EXIT=$?
          set -e

          # rsync exit codes: 0=success, 24=partial transfer (vanished files, not critical)
          if [ $RSYNC_EXIT -ne 0 ] && [ $RSYNC_EXIT -ne 24 ]; then
            echo "rsync failed with exit code $RSYNC_EXIT"
            exit $RSYNC_EXIT
          fi

          # 确保删除公开仓库中的敏感文件（如果存在）
          cd public-repo
          for file in "${SENSITIVE_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "Removing sensitive file: $file"
              rm -f "$file"
            fi
          done
          cd ..

      - name: Commit and push to public repo
        working-directory: public-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 检查是否有变更
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to sync"
            exit 0
          fi

          # 获取原始提交信息（从环境变量或 git）
          if [ -n "$GITHUB_SHA" ]; then
            COMMIT_HASH="${GITHUB_SHA:0:7}"
            COMMIT_MSG=$(git -C .. log -1 --pretty=%B "$GITHUB_SHA")
          else
            COMMIT_MSG=$(git -C .. log -1 --pretty=%B)
            COMMIT_HASH=$(git -C .. rev-parse --short HEAD)
          fi

          # 提交变更
          git add -A
          git commit -m "sync: $COMMIT_MSG" -m "Synced from private repo: $COMMIT_HASH" -m "Auto-generated commit - sensitive content removed"

          # 推送（带自动 rebase 处理）
          if ! git push origin main; then
            echo "Push failed, trying rebase..."
            git fetch origin

            if git rebase origin/main; then
              echo "Rebase successful, pushing..."
              git push origin main
            else
              echo "Rebase failed, using force-with-lease..."
              git rebase --abort
              git push --force-with-lease origin main
            fi
          fi
