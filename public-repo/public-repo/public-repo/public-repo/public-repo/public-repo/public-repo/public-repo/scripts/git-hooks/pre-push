#!/bin/bash

# Pre-push hook: 防止直接推送到 main 分支

# 获取当前分支（正确处理包含斜杠的分支名）
current_branch=$(git symbolic-ref --short HEAD)

# 检查是否推送到 main
while read local_ref local_sha remote_ref remote_sha
do
    if [ "$remote_ref" = "refs/heads/main" ]; then
        echo ""
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "❌ ERROR: Direct push to main branch is blocked!"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo ""
        echo "Please follow the proper workflow:"
        echo ""
        echo "1. Create a feature branch:"
        echo "   git checkout -b feat/your-feature-name"
        echo ""
        echo "2. Push your feature branch:"
        echo "   git push origin feat/your-feature-name"
        echo ""
        echo "3. Create a Pull Request on GitHub"
        echo ""
        echo "4. Merge after CI checks pass"
        echo ""
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        exit 1
    fi
done

# 检查分支命名规范
if [[ ! "$current_branch" =~ ^(feat|fix|refactor|chore|docs|test)/.+ ]] && [ "$current_branch" != "main" ]; then
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "⚠️  WARNING: Branch name doesn't follow convention"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "Current branch: $current_branch"
    echo ""
    echo "Recommended format: <type>/<description>"
    echo "  - feat/add-new-strategy"
    echo "  - fix/position-sizing-bug"
    echo "  - refactor/simplify-config"
    echo ""
    echo "Continue anyway? (y/N)"
    read -r response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

exit 0
